
@{
    Layout = null;
}
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>@ViewBag.Title</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <link rel='shortcut icon' href='~/Images/favicon.ico' />
    <link href="~/Content/Site.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>
    <script src="~/Scripts/public.js"></script>
    <script>
        if (top.location != self.location) {
            top.location = self.location;
        }
        var rw = QueryString("rw");
        $(function () {
            if (location.href.indexOf('?') >= 0) {
                $("#UserCode").val("");
                $("#UserPwd").val("");
            }

        });
        function codeChange() {
            $('#Verification1').attr('src', '/Service/ValidateCode.aspx?t=' + Math.random(1));
            $("#authCode").val("");
            $("#authCode").focus();
        }
        function login() {
            if ($("#UserCode").val() == "") {
                alert("请填写账号！");
                $("#UserCode").focus();
                return false;
            }
            if ($("#UserPwd").val() == "") {
                alert("请填写密码！");
                $("#UserPwd").focus();
                return false;
            }
            var display = $('#yzm').css('display');
            if (display == 'block') {
                if ($("#authCode").val() == "") {
                    alert("请填写验证码！");
                    $("#authCode").focus();
                    return false;
                }
            }

            if ($("#btnLogin").html() != "登录")
                return;

            $("#btnLogin").html("登录中...");

            var rememberPwd = 0;
            if ($("#rememberPwd").prop("checked"))
                rememberPwd = 1;
            else
                rememberPwd = 0;

            //layer.msg('登录检测中...', { icon: 6, shade: 0.2 });

            var strWhere = { loginCode: $("#UserCode").val(), passWord: $("#UserPwd").val(), authCode: $("#authCode").val(), rememberPwd: rememberPwd, isForceLogin: false, issupplier: 1, isclient: 1 };
            $.ajax({
                url: "/api/userinfo/login",
                type: "POST",
                dataType: 'json',
                data: strWhere,
                async: true,
                success: function (r) {
                    if (r.Success) {
                        if (r.Data == 0) {
                            if (rw != '')
                                location.href = rw;
                            else {
                                location.href = "/home/index"
                            }
                        }
                        else if (r.Data == 1) {
                            location.href = "/Shop/";
                        }
                        else if (r.Data == 2) {
                            location.href = "/Supplier/";
                        }
                        else {
                            alert("未知的登录类型");
                        }
                    }
                    else if (r.code == 999) {
                        if (confirm("其他设备已经登录,是否强制登录?")) {
                            strWhere = { loginCode: $("#UserCode").val(), passWord: $("#UserPwd").val(), rememberPwd: rememberPwd, isForceLogin: true, issupplier: 1, isclient: 1 };
                            $.ajax({
                                url: "/api/userinfo/login",
                                type: "POST",
                                dataType: 'json',
                                data: JSON.stringify(strWhere),
                                async: true,
                                success: function (r) {
                                    if (r.code == 0) {
                                        if (r.outData == 0) {
                                            if (rw != '')
                                                location.href = rw;
                                            else
                                                location.href = "/Main/"
                                        }
                                        else if (r.outData == 1) {
                                            location.href = "/Shop/";
                                        }
                                        else if (r.outData == 2) {
                                            location.href = "/Supplier/";
                                        }
                                        else {
                                            alert("未知的登录类型");
                                        }

                                    } else {
                                        $("#btnLogin").html("登录");
                                        alert(r.msg);
                                    }
                                },
                                error: function (r) {
                                    $("#btnLogin").html("登录");
                                    //alert("异常错误");
                                }
                            });
                        } else {
                            $("#btnLogin").html("登录");
                        }
                    }
                    else {
                        if (r.code != 0) {
                            $("#yzm").css("display", "block");
                        }
                        $("#btnLogin").html("登录");
                        codeChange();
                        alert(r.msg);
                    }
                },
                error: function (r) {
                    $("#btnLogin").html("登录");
                    //alert("异常错误");
                }
            });
        }

        $(function () {
            var userc = "";
            var userp = "";
            if (userc != "") {
                $("#UserCode").val(userc);
                if (userp != "")
                    $("#UserPwd").val(userp);
            }

            $("#UserPwd").keydown(function (event) {
                if (event.which == 13) {
                    var display = $('#yzm').css('display');
                    if (display == 'block') {
                        $("#authCode").focus();
                        $("#authCode").select();
                    } else {
                        login();
                    }
                    event.preventDefault();
                }
            });
            $("#UserCode").keydown(function (event) {
                if (event.which == 13) {
                    $("#UserPwd").focus();
                    $("#UserPwd").select();
                }
            });
            $("#authCode").keydown(function (event) {
                if (event.which == 13) {
                    login();
                    event.preventDefault();
                }
            });
        });

/**/</script>
</head>
<body>
    <div style="background-repeat: no-repeat;">
        <div class="header">
            <div class="header-logo">
                <span class="header-system"></span>
            </div>
            <span class="header-com"></span>
        </div>
        <div style="width: 1200px; height: 450px; margin: 117px auto 0px auto;">
            <div class="login_img">
            </div>
            <div class="login_info" style="height:409px;margin-left:10px">
                <ul>
                    <li style="padding-top: 35px; height: 50px; font-weight: bold; color: #000000; font-size: 18px; text-align: center; width: 260px;">登录系统</li>
                    <li>
                        <input id="UserCode" name="UserCode" type="text" class="login_input" value="" placeholder='登录账号' />
                    </li>
                    <li>
                        <input id="UserPwd" name="UserPwd" type="password" class="login_input" style="background-position-y: -40px;" value="" placeholder="密码" />
                    </li>
                    <li class="item" id="yzm" style="display: none; height: auto;">
                        <span class="label">验证码：</span>
                        <div class="fl">
                            <input type="text" id="authCode" name="authCode" tabindex="2" class="login_ValidateCode" maxlength="4" />
                            <img style="cursor: pointer; width: 100px; height: 40px; align-content: center;" alt="验证码" onclick="codeChange()" src="/Service/ValidateCode.aspx" id="Verification1" />
                            <div class="msg-error" id="authCode_error"></div>
                        </div>

                    </li>
                    <li style="height: 30px">
                        <input type="checkbox" id="rememberPwd" checked="checked" /><label for="rememberPwd">记住密码</label>
                    </li>
                    <li style="height: 50px">
                        <a href="javascript:void(0);" class="login_input login_bt" id="btnLogin" onclick="return login()">登录</a>
                    </li>                   
                </ul>
            </div>

        </div>
    </div>
</body>
</html>
